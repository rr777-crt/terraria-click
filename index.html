<!DOCTYPE html>
<html>
<head>
    <title>Advanced Tower Defense</title>
    <style>
         .tile {
            z-index: 1;
        }
        
        /* Башни должны быть поверх плиток */
        .tower {
            z-index: 2;
        }
        
        /* Враги поверх всего */
        .enemy {
            z-index: 3;
        }
          .tower.toxic {
            background: #4CAF50;
            clip-path: polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%);
        }
        
        .tower.knight {
            background: #607D8B;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
        }
        
        .enemy.purple {
            background: #9C27B0;
        }
        
        .enemy.gold {
            background: #FFD700;
        }
        
        .enemy.green {
            background: #009688;
            width: 30px;
            height: 30px;
        }
        
        .enemy.boss {
            background: #F44336;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            width: 40px;
            height: 40px;
        }
        
        .enemy.black {
            background: #000;
        }
        
        .enemy.pink {
            background: #E91E63;
        }
        
        .health-bar {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 12px;
            text-shadow: 1px 1px 2px black;
            pointer-events: none;
        }
        
        .boss-radius {
            border: 3px solid red;
            border-radius: 50%;
            position: absolute;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        #gameContainer {
            display: flex;
        }
        
        #gameBoard {
            width: 1000px; /* Увеличено для расширенного пути */
            height: 700px; /* Увеличено для расширенного пути */
            border: 1px solid black;
            position: relative;
            background: #eee;
        }
        
        .tile {
            width: 40px;
            height: 40px;
            position: absolute;
        }
        
        .path {
            background: #666;
        }
        
        .start {
            background: gold;
        }
        
        .end {
            background: green;
        }
        
        .enemy {
            width: 20px;
            height: 20px;
            background: red;
            position: absolute;
            border-radius: 50%;
        }
        
        .tower {
            width: 30px;
            height: 30px;
            position: absolute;
            cursor: pointer;
            transform: translate(-15px, -15px); /* Центрирование башни */
        }
        
        .tower.pistol {
            background: blue;
            border-radius: 50%;
        }
        
        .tower.swordsman {
            background: brown;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
        }
        
        .tower.sniper {
            background: purple;
        }
        
        .radius {
            position: absolute;
            border: 1px dashed rgba(0,0,255,0.5);
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%); /* Правильное позиционирование */
            box-sizing: border-box;
        }
        
        #shop {
            padding: 20px;
            background: #ccc;
            width: 250px;
        }
        
        #upgradeMenu {
            position: fixed;
            right: 250px;
            top: 20px;
            background: #fff;
            padding: 15px;
            border: 2px solid #FFB74D;
            border-radius: 10px;
            display: none;
            z-index: 1000;
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        
        .shop-item {
            margin: 10px 0;
            padding: 12px;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            cursor: pointer;
            background: linear-gradient(145deg, #81C784, #66BB6A);
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .shop-item:hover {
            background: linear-gradient(145deg, #66BB6A, #4CAF50);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        #upgradeMenu button {
            margin: 8px 0;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background: linear-gradient(145deg, #FFA726, #FB8C00);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        #upgradeMenu button:hover {
            background: linear-gradient(145deg, #FB8C00, #F57C00);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        #gameOver {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            display: none;
            z-index: 2000;
        }
        
        #gameOver button {
            padding: 10px 20px;
            margin-top: 20px;
            font-size: 16px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="gameBoard"></div>
        <div id="shop">
            <div class="shop-item" onclick="selectTower('pistol', 50)">
                Пистолет (50)<br>
                Урон: 1/сек<br>
                Радиус: 10st
            </div>
            <div class="shop-item" onclick="selectTower('swordsman', 80)">
                Мечник (80)<br>
                Урон: 2/0.5сек<br>
                Радиус: 5st
            </div>
            <div class="shop-item" onclick="selectTower('sniper', 250)">
                Снайпер (250)<br>
                Урон: 10/5сек<br>
                Радиус: 100st
            </div>
            <div id="upgradeMenu">
                <h4>Улучшение башни</h4>
                <div id="towerStats"></div>
                <button onclick="upgradeTower()">Улучшить</button>
                <button onclick="closeUpgradeMenu()">Закрыть</button>
            </div>
            <div style="margin-top: 20px; font-weight: bold;">
                Деньги: <span id="money">100</span>
            </div>
            <div style="font-weight: bold;">
                Волна: <span id="wave">1</span>
            </div>
        </div>
    </div>
    <div class="shop-item" onclick="selectTower('toxic', 450)">
            Токсичный (450)<br>
            Урон: 10/3сек<br>
            Радиус: 2st
        </div>
        <div class="shop-item" onclick="selectTower('knight', 1000)">
            Рыцарь (1000)<br>
            Двойной радиус<br>
            Урон: 2+5/сек
        </div>
    </div>

    
    <div id="gameOver">
        <h2>Враги добрались до цели!</h2>
        <p>Игра окончена</p>
        <button onclick="restartGame()">Играть снова</button>
    </div>

    <script>
        const board = document.getElementById('gameBoard');
        const tileSize = 40;
        let placingTower = false;
        let money = 100;
        let currentWave = 1;
        let enemies = [];
        let towers = [];
        let selectedTower = null;
        let waveInProgress = false;
        let gameActive = true;

        const towerTypes = {
            pistol: {
                type: 'pistol',
                cost: 50,
                damage: 1,
                radius: 100,
                attackSpeed: 1,
                upgraded: false,
                upgradeCost: 150,
                upgradedDamage: 2,
                upgradedRadius: 150
            },
            swordsman: {
                type: 'swordsman',
                cost: 80,
                damage: 2,
                radius: 50,
                attackSpeed: 2,
                upgraded: false,
                upgradeCost: 150,
                upgradedDamage: 3,
                upgradedAttackSpeed: 3
            },
            sniper: {
                type: 'sniper',
                cost: 250,
                damage: 10,
                radius: 1000,
                attackSpeed: 0.2,
                upgraded: false,
                upgradeCost: 1000,
                upgradedAttackSpeed: 0.4
            }
        };

        function createBoard() {
            // Расширенный путь с изгибами
            const path = [
                {x:0, y:4}, {x:1, y:4}, {x:2, y:4}, {x:3, y:4}, {x:4, y:4}, {x:5, y:4},
                {x:5, y:5}, {x:5, y:6}, {x:5, y:7}, {x:5, y:8}, {x:5, y:9},
                {x:6, y:9}, {x:7, y:9}, {x:8, y:9}, {x:9, y:9}, {x:10, y:9},
                {x:10, y:8}, {x:10, y:7}, {x:10, y:6}, {x:10, y:5},
                {x:11, y:5}, {x:12, y:5}, {x:13, y:5}, {x:14, y:5}, {x:15, y:5},
                {x:15, y:6}, {x:15, y:7}, {x:15, y:8}, {x:15, y:9}, {x:15, y:10},
                {x:16, y:10}, {x:17, y:10}, {x:18, y:10}, {x:19, y:10}, {x:20, y:10},
                {x:20, y:11}
            ];
            
            // Создаем дорожку
            path.forEach((pos, index) => {
                const tile = document.createElement('div');
                tile.className = `tile ${index === 0 ? 'start' : index === path.length-1 ? 'end' : 'path'}`;
                tile.style.left = pos.x * tileSize + 'px';
                tile.style.top = pos.y * tileSize + 'px';
                board.appendChild(tile);
            });
            
            // Запоминаем позицию конечной точки
            endPosition = {
                x: path[path.length-1].x * tileSize,
                y: path[path.length-1].y * tileSize
            };
        }

        function selectTower(type, cost) {
            if(!gameActive) return;
            if(money >= cost && !placingTower) {
                placingTower = type;
                money -= cost;
                updateMoney();
            }
        }

        board.addEventListener('click', (e) => {
            if(!gameActive) return;
            if(placingTower) {
                const rect = board.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Проверка на дорожку
                const isPath = [...document.querySelectorAll('.tile')].some(tile => {
                    const tileX = parseInt(tile.style.left);
                    const tileY = parseInt(tile.style.top);
                    return x >= tileX && x <= tileX + tileSize && 
                           y >= tileY && y <= tileY + tileSize;
                });
                
                // Проверка на другие башни
                const isTower = towers.some(tower => {
                    return Math.sqrt(Math.pow(x - tower.x, 2) + Math.pow(y - tower.y, 2)) < 30;
                });
                
                if(!isPath && !isTower) {
                    const tower = {
                        ...towerTypes[placingTower],
                        x: x,
                        y: y,
                        totalDamage: 0,
                        lastAttack: 0
                    };
                    towers.push(tower);
                    placeTower(tower);
                    placingTower = false;
                }
            }
        });

        function placeTower(tower) {
            const elem = document.createElement('div');
            elem.className = `tower ${tower.type}`;
            elem.style.left = tower.x + 'px';
            elem.style.top = tower.y + 'px';
            elem.onclick = () => showUpgradeMenu(tower);
            
            const radius = document.createElement('div');
            radius.className = 'radius';
            radius.style.width = tower.radius*2 + 'px';
            radius.style.height = tower.radius*2 + 'px';
            radius.style.left = tower.x + 'px';
            radius.style.top = tower.y + 'px';
            
            board.appendChild(elem);
            board.appendChild(radius);
            tower.elem = elem;
            tower.radiusElem = radius;
        }

        function spawnEnemy(hp) {
            const enemy = {
                x: 0,
                y: 4 * tileSize + 10,
                hp: hp,
                pathIndex: 0
            };
            enemies.push(enemy);
            
            const elem = document.createElement('div');
            elem.className = 'enemy';
            elem.style.left = enemy.x + 'px';
            elem.style.top = enemy.y + 'px';
            board.appendChild(elem);
            enemy.elem = elem;
        }

        function gameLoop() {
            if(!gameActive) return;
            
            // Проверяем, достиг ли кто-то конца
            enemies.forEach((enemy, index) => {
                const path = document.querySelectorAll('.tile');
                if(enemy.pathIndex >= path.length - 1) {
                    // Враг достиг конца
                    enemy.elem.remove();
                    enemies.splice(index, 1);
                    endGame();
                    return;
                }
                
                const target = path[enemy.pathIndex + 1];
                if(target) {
                    const targetX = parseInt(target.style.left) + tileSize/2;
                    const targetY = parseInt(target.style.top) + tileSize/2;
                    
                    const dx = targetX - enemy.x;
                    const dy = targetY - enemy.y;
                    const distance = Math.sqrt(dx*dx + dy*dy);
                    
                    if(distance < 2) {
                        enemy.pathIndex++;
                    } else {
                        const speed = 2;
                        enemy.x += (dx / distance) * speed;
                        enemy.y += (dy / distance) * speed;
                    }
                    
                    enemy.elem.style.left = enemy.x + 'px';
                    enemy.elem.style.top = enemy.y + 'px';
                }
            });
            
            attackLogic();
            requestAnimationFrame(gameLoop);
        }

        function attackLogic() {
            towers.forEach(tower => {
                // Находим ближайшего врага в радиусе
                let closestEnemy = null;
                let minDistance = Infinity;
                
                enemies.forEach(enemy => {
                    const dx = enemy.x - tower.x;
                    const dy = enemy.y - tower.y;
                    const distance = Math.sqrt(dx*dx + dy*dy);
                    
                    if(distance < tower.radius && distance < minDistance) {
                        closestEnemy = enemy;
                        minDistance = distance;
                    }
                });
                
                // Атакуем ближайшего врага
                if(closestEnemy && Date.now() - tower.lastAttack > 1000/tower.attackSpeed) {
                    closestEnemy.hp -= tower.damage;
                    tower.totalDamage += tower.damage;
                    tower.lastAttack = Date.now();
                    
                    if(closestEnemy.hp <= 0) {
                        closestEnemy.elem.remove();
                        enemies.splice(enemies.indexOf(closestEnemy), 1);
                        money += 10;
                        updateMoney();
                    }
                }
            });
            
            checkWaveCompletion();
        }

        function checkWaveCompletion() {
            if(enemies.length === 0 && waveInProgress) {
                waveInProgress = false;
                currentWave++;
                startWave();
            }
        }

        function startWave() {
            if(!gameActive) return;
            
            waveInProgress = true;
            document.getElementById('wave').textContent = currentWave;
            
            if(currentWave === 1) {
                for(let i = 0; i < 3; i++) {
                    setTimeout(() => spawnEnemy(2), i*2000);
                }
            } else if(currentWave === 2) {
                for(let i = 0; i < 5; i++) {
                    setTimeout(() => spawnEnemy(2), i*2000);
                }
            } else if(currentWave === 3) {
                for(let i = 0; i < 10; i++) {
                    setTimeout(() => spawnEnemy(2), i*1500);
                }
            } else if(currentWave === 4) {
                for(let i = 0; i < 15; i++) {
                    setTimeout(() => spawnEnemy(2), i*1000);
                }
            } else if(currentWave === 5) {
                for(let i = 0; i < 5; i++) {
                    setTimeout(() => spawnEnemy(2), i*1500);
                }
                setTimeout(() => spawnEnemy(5), 5*1500);
            }
        }

        function showUpgradeMenu(tower) {
            if(!gameActive) return;
            
            closeUpgradeMenu();
            selectedTower = tower;
            const menu = document.getElementById('upgradeMenu');
            menu.style.display = 'block';
            
            let upgradeButton = menu.querySelector('button');
            upgradeButton.textContent = `Улучшить (${tower.upgradeCost})`;
            
            document.getElementById('towerStats').innerHTML = `
                <strong>${getTowerName(tower.type)}</strong><br>
                Урон: ${tower.damage}<br>
                Радиус: ${Math.round(tower.radius/10)}st<br>
                Скорость: ${(1/tower.attackSpeed).toFixed(1)} атак/сек<br>
                ${tower.upgraded ? '<span style="color:green">УЛУЧШЕНО</span>' : ''}
            `;
        }

        function getTowerName(type) {
            switch(type) {
                case 'pistol': return 'Пистолет';
                case 'swordsman': return 'Мечник';
                case 'sniper': return 'Снайпер';
                default: return 'Башня';
            }
        }

        function closeUpgradeMenu() {
            document.getElementById('upgradeMenu').style.display = 'none';
            selectedTower = null;
        }

        function upgradeTower() {
            if(!selectedTower || !gameActive) return;
            if(selectedTower.upgraded || money < selectedTower.upgradeCost) return;
            
            money -= selectedTower.upgradeCost;
            updateMoney();
            selectedTower.upgraded = true;
            
            switch(selectedTower.type) {
                case 'pistol':
                    selectedTower.damage = selectedTower.upgradedDamage;
                    selectedTower.radius = selectedTower.upgradedRadius;
                    break;
                case 'swordsman':
                    selectedTower.damage = selectedTower.upgradedDamage;
                    selectedTower.attackSpeed = selectedTower.upgradedAttackSpeed;
                    break;
                case 'sniper':
                    selectedTower.attackSpeed = selectedTower.upgradedAttackSpeed;
                    break;
            }
            
            updateTowerVisuals(selectedTower);
            showUpgradeMenu(selectedTower);
        }

        function updateTowerVisuals(tower) {
            if(tower.radiusElem) {
                tower.radiusElem.style.width = tower.radius*2 + 'px';
                tower.radiusElem.style.height = tower.radius*2 + 'px';
            }
        }

        function updateMoney() {
            document.getElementById('money').textContent = money;
        }

        function endGame() {
            gameActive = false;
            document.getElementById('gameOver').style.display = 'block';
        }

        function restartGame() {
            // Очищаем игровое поле
            board.innerHTML = '';
            enemies = [];
            towers = [];
            
            // Сбрасываем параметры
            money = 100;
            currentWave = 1;
            gameActive = true;
            
            // Обновляем интерфейс
            updateMoney();
            document.getElementById('wave').textContent = currentWave;
            document.getElementById('gameOver').style.display = 'none';
            closeUpgradeMenu();
            
            // Перезапускаем игру
            createBoard();
            startWave();
            gameLoop();
        }

        // Инициализация игры
        function initGame() {
            money = 100;
            currentWave = 1;
            enemies = [];
            towers = [];
            selectedTower = null;
            waveInProgress = false;
            gameActive = true;
            
            board.innerHTML = '';
            createBoard();
            
            updateMoney();
            document.getElementById('wave').textContent = currentWave;
            document.getElementById('gameOver').style.display = 'none';
            closeUpgradeMenu();
            
            gameLoop();
            startWave();
        }
      function placeTower(tower) {
    const elem = document.createElement('div');
    elem.className = `tower ${tower.type}`;
    elem.style.left = tower.x + 'px';
    elem.style.top = tower.y + 'px';
    
    let clickCount = 0;
    let clickTimer = null;
    
    elem.onclick = (e) => {
        e.stopPropagation();
        clickCount++;
        
        if (clickTimer === null) {
            clickTimer = setTimeout(() => {
                if (clickCount === 1) {
                    showUpgradeMenu(tower);
                } else if (clickCount === 3) {
                    removeTower(tower);
                }
                clickCount = 0;
                clickTimer = null;
            }, 300);
        }
    };
    
    const radius = document.createElement('div');
    radius.className = 'radius';
    radius.style.width = tower.radius*2 + 'px';
    radius.style.height = tower.radius*2 + 'px';
    radius.style.left = tower.x + 'px';
    radius.style.top = tower.y + 'px';
    
    board.appendChild(elem);
    board.appendChild(radius);
    tower.elem = elem;
    tower.radiusElem = radius;
}

function removeTower(tower) {
    if (!gameActive) return;
    
    // Возвращаем 50% стоимости башни
    const refund = Math.floor(towerTypes[tower.type].cost * 0.5);
    money += refund;
    updateMoney();
    
    // Удаляем элементы из DOM
    if (tower.elem) tower.elem.remove();
    if (tower.radiusElem) tower.radiusElem.remove();
    
    // Удаляем из массива башен
    towers = towers.filter(t => t !== tower);
    
    // Закрываем меню, если удаляем выбранную башню
    if (selectedTower === tower) {
        closeUpgradeMenu();
    }
}

// Исправленная функция startWave
function startWave() {
    if(!gameActive) return;
    
    waveInProgress = true;
    document.getElementById('wave').textContent = currentWave;
    
    if(currentWave === 1) {
        for(let i = 0; i < 3; i++) {
            setTimeout(() => spawnEnemy(2), i*2000);
        }
    } else if(currentWave === 2) {
        for(let i = 0; i < 5; i++) {
            setTimeout(() => spawnEnemy(2), i*2000);
        }
    } else if(currentWave === 3) {
        for(let i = 0; i < 10; i++) {
            setTimeout(() => spawnEnemy(2), i*1500);
        }
    } else if(currentWave === 4) {
        for(let i = 0; i < 15; i++) {
            setTimeout(() => spawnEnemy(2), i*1000);
        }
    } else if(currentWave === 5) {
        for(let i = 0; i < 5; i++) {
            setTimeout(() => spawnEnemy(2), i*1500);
        }
        setTimeout(() => spawnEnemy(5), 5*1500);
    }
}

        window.addEventListener('load', initGame);
        const towerTypes = {
    // ... предыдущие башни ...
    toxic: {
        type: 'toxic',
        cost: 450,
        damage: 10,
        radius: 20,
        attackSpeed: 0.33,
        upgraded: false,
        upgradeCost: 900,
        upgradedRadius: 70,
        upgradedAttackSpeed: 0.58
    },
    knight: {
        type: 'knight',
        cost: 1000,
        damage1: 2,
        radius1: 50,
        attackSpeed1: 2,
        damage2: 5,
        radius2: 150,
        attackSpeed2: 0.67,
        upgraded: false,
        upgradeCost: 2500
    }
};

// Модифицированная функция спавна врагов
function spawnEnemy(type) {
    const enemyTypes = {
        basic: { hp: 2, color: 'red', speed: 2 },
        purple: { hp: 5, color: 'purple', speed: 2 },
        gold: { hp: 15, color: 'gold', speed: 4 },
        green: { hp: 100, color: 'green', speed: 1 },
        boss: { hp: 250, color: 'boss', speed: 2 },
        black: { hp: 200, color: 'black', speed: 0.7 },
        pink: { hp: 50, color: 'pink', speed: 6 }
    };
    
    const enemy = {
        ...enemyTypes[type],
        x: 0,
        y: 4 * tileSize + 10,
        pathIndex: 0
    };
    
    // Добавлен текст с HP
    const healthText = document.createElement('div');
    healthText.className = 'health-bar';
    healthText.textContent = enemy.hp;
    
    const elem = document.createElement('div');
    elem.className = `enemy ${enemy.color}`;
    elem.style.left = enemy.x + 'px';
    elem.style.top = enemy.y + 'px';
    
    elem.appendChild(healthText);
    board.appendChild(elem);
    enemy.elem = elem;
    enemy.healthText = healthText;
    enemies.push(enemy);
}

// Обновлённая логика волн
function startWave() {
    if(!gameActive) return;
    
    waveInProgress = true;
    document.getElementById('wave').textContent = currentWave;
    
    let spawnInterval = 1000;
    let enemyCount = currentWave * 2;
    
    if(currentWave >= 5) {
        // Добавлены новые типы врагов
        for(let i = 0; i < Math.floor(currentWave/5); i++) {
            setTimeout(() => spawnEnemy('purple'), i*spawnInterval);
        }
    }
    if(currentWave >= 15) {
        setTimeout(() => spawnEnemy('gold'), enemyCount*spawnInterval);
    }
    if(currentWave === 50) {
        const boss = spawnEnemy('boss');
        // Добавлен радиус босса
        const radius = document.createElement('div');
        radius.className = 'boss-radius';
        radius.style.width = boss.radius*2 + 'px';
        radius.style.height = boss.radius*2 + 'px';
        radius.style.left = boss.x + 'px';
        radius.style.top = boss.y + 'px';
        board.appendChild(radius);
        boss.radiusElem = radius;
    }
    // ... аналогично для других волн ...
}

// Фикс бага с волнами
let scheduledEnemies = 0;

function startWave() {
    // ... предыдущий код ...
    
    scheduledEnemies = enemyCount;
    for(let i = 0; i < enemyCount; i++) {
        setTimeout(() => {
            spawnEnemy(/* тип врага */);
            scheduledEnemies--;
        }, i*spawnInterval);
    }
}

function checkWaveCompletion() {
    if(enemies.length === 0 && scheduledEnemies === 0 && waveInProgress) {
        waveInProgress = false;
        currentWave++;
        setTimeout(startWave, 2000); // Задержка перед следующей волной
    }
}

// Обновлённая логика атаки для новых башен
function attackLogic() {
    towers.forEach(tower => {
        if(tower.type === 'knight') {
            // Логика двойной атаки
            attackWithRadius(tower, tower.radius1, tower.damage1, tower.attackSpeed1);
            attackWithRadius(tower, tower.radius2, tower.damage2, tower.attackSpeed2);
        } else {
            // Стандартная логика атаки
        }
    });
}

function attackWithRadius(tower, radius, damage, speed) {
    // Общая логика поиска и атаки врагов в радиусе
}

// Обновление HP врагов
function updateEnemyHealth(enemy) {
    if(enemy.healthText) {
        enemy.healthText.textContent = enemy.hp;
        enemy.healthText.style.transform = `translate(${enemy.x}px, ${enemy.y - 20}px)`;
    }
}
        function createBoard() {
    const path = [
        {x:0, y:4}, {x:1, y:4}, {x:2, y:4}, {x:3, y:4}, {x:4, y:4}, {x:5, y:4},
        {x:5, y:5}, {x:5, y:6}, {x:5, y:7}, {x:5, y:8}, {x:5, y:9},
        {x:6, y:9}, {x:7, y:9}, {x:8, y:9}, {x:9, y:9}, {x:10, y:9},
        {x:10, y:8}, {x:10, y:7}, {x:10, y:6}, {x:10, y:5},
        {x:11, y:5}, {x:12, y:5}, {x:13, y:5}, {x:14, y:5}, {x:15, y:5},
        {x:15, y:6}, {x:15, y:7}, {x:15, y:8}, {x:15, y:9}, {x:15, y:10},
        {x:16, y:10}, {x:17, y:10}, {x:18, y:10}, {x:19, y:10}, {x:20, y:10},
        {x:20, y:11}
    ];

    path.forEach((pos, index) => {
        const tile = document.createElement('div');
        tile.className = `tile ${index === 0 ? 'start' : index === path.length-1 ? 'end' : 'path'}`;
        tile.style.left = pos.x * tileSize + 'px';
        tile.style.top = pos.y * tileSize + 'px';
        board.appendChild(tile);
    });

    endPosition = {
        x: path[path.length-1].x * tileSize,
        y: path[path.length-1].y * tileSize
    };
}

// Исправленный обработчик клика для башен
board.addEventListener('click', (e) => {
    if(!gameActive) return;
    if(placingTower) {
        const rect = board.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // Обновленная проверка пути
        const isPath = [...document.querySelectorAll('.tile.path, .tile.start, .tile.end')]
            .some(tile => {
                const tileX = parseInt(tile.style.left);
                const tileY = parseInt(tile.style.top);
                return x >= tileX && x <= tileX + tileSize && 
                       y >= tileY && y <= tileY + tileSize;
            });
        
        const isTower = towers.some(tower => {
            return Math.sqrt(Math.pow(x - tower.x, 2) + Math.pow(y - tower.y, 2) < 30;
        });
        
        if(!isPath && !isTower) {
            const tower = {
                ...towerTypes[placingTower],
                x: x,
                y: y,
                totalDamage: 0,
                lastAttack: 0
            };
            towers.push(tower);
            placeTower(tower);
            placingTower = false;
        }
    }
});

// Важно добавить вызов createBoard в инициализацию
function initGame() {
    money = 100;
    currentWave = 1;
    enemies = [];
    towers = [];
    selectedTower = null;
    waveInProgress = false;
    gameActive = true;
    
    board.innerHTML = '';
    createBoard(); // ← ВОССТАНОВЛЕН ВЫЗОВ СОЗДАНИЯ ПУТИ
    
    updateMoney();
    document.getElementById('wave').textContent = currentWave;
    document.getElementById('gameOver').style.display = 'none';
    closeUpgradeMenu();
    
    gameLoop();
    startWave();
}
    </script>
</body>
</html>
